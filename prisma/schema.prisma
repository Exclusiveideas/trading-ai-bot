generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model RawCandle {
  id              Int                @id @default(autoincrement())
  pair            String             @db.VarChar(20)
  timestamp       DateTime           @db.Timestamptz(6)
  open            Float
  high            Float
  low             Float
  close           Float
  volume          Float              @default(0)
  timeframe       String             @default("D") @db.VarChar(10)
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  features        CalculatedFeature?
  contextFeatures ContextFeature?

  @@unique([pair, timestamp, timeframe])
  @@index([pair, timeframe, timestamp(sort: Desc)])
  @@map("raw_candles")
}

model CalculatedFeature {
  id            Int       @id @default(autoincrement())
  candleId      Int       @unique @map("candle_id")
  sma20         Float?    @map("sma_20")
  sma50         Float?    @map("sma_50")
  ema200        Float?    @map("ema_200")
  rsi           Float?
  macd          Float?
  macdSignal    Float?    @map("macd_signal")
  macdHistogram Float?    @map("macd_histogram")
  adx           Float?
  atr           Float?
  bbUpper       Float?    @map("bb_upper")
  bbMiddle      Float?    @map("bb_middle")
  bbLower       Float?    @map("bb_lower")
  volumeSma     Float?    @map("volume_sma")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  candle        RawCandle @relation(fields: [candleId], references: [id], onDelete: Cascade)

  @@index([candleId])
  @@map("calculated_features")
}

model ContextFeature {
  id                    Int       @id @default(autoincrement())
  candleId              Int       @unique @map("candle_id")
  nearestSupport        Float?    @map("nearest_support")
  nearestResistance     Float?    @map("nearest_resistance")
  distToSupportPips     Float?    @map("dist_to_support_pips")
  distToResistancePips  Float?    @map("dist_to_resistance_pips")
  distToSupportAtr      Float?    @map("dist_to_support_atr")
  distToResistanceAtr   Float?    @map("dist_to_resistance_atr")
  trendState            String?   @map("trend_state") @db.VarChar(30)
  tradingSession        String?   @map("trading_session") @db.VarChar(20)
  nearestRoundNumber    Float?    @map("nearest_round_number")
  distToRoundNumberPips Float?    @map("dist_to_round_number_pips")
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  candle                RawCandle @relation(fields: [candleId], references: [id], onDelete: Cascade)

  @@index([candleId])
  @@map("context_features")
}

model LabeledPattern {
  id             Int      @id @default(autoincrement())
  pair           String   @db.VarChar(20)
  patternType    String   @map("pattern_type") @db.VarChar(30)
  startTimestamp DateTime @map("start_timestamp") @db.Timestamptz(6)
  endTimestamp   DateTime @map("end_timestamp") @db.Timestamptz(6)
  entryPrice     Float    @map("entry_price")
  stopLoss       Float    @map("stop_loss")
  takeProfit     Float    @map("take_profit")
  outcome        String   @default("pending") @db.VarChar(15)
  rMultiple      Float?   @map("r_multiple")
  barsToOutcome  Int?     @map("bars_to_outcome")
  maxFavorableExcursion Float? @map("max_favorable_excursion")
  qualityRating  Int      @map("quality_rating")
  trendState     String?  @map("trend_state") @db.VarChar(30)
  session        String?  @db.VarChar(20)
  supportQuality Float?   @map("support_quality")
  notes          String?
  contextJson    Json?    @map("context_json")
  timeframe      String   @default("D") @db.VarChar(10)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([pair, patternType])
  @@index([pair, timeframe])
  @@index([outcome])
  @@map("labeled_patterns")
}

model Signal {
  id              Int       @id @default(autoincrement())
  pair            String    @db.VarChar(20)
  timeframe       String    @db.VarChar(10)
  patternType     String    @map("pattern_type") @db.VarChar(30)
  direction       String    @db.VarChar(10)
  entryPrice      Float     @map("entry_price")
  stopLoss        Float     @map("stop_loss")
  takeProfit      Float     @map("take_profit")
  patternStart    DateTime  @map("pattern_start") @db.Timestamptz(6)
  patternEnd      DateTime  @map("pattern_end") @db.Timestamptz(6)
  qualityRating   Int       @map("quality_rating")
  confidence      Float
  v1WinProb       Float?    @map("v1_win_prob")
  v2MfeBucket     String?   @map("v2_mfe_bucket") @db.VarChar(20)
  v2BucketProbs   Json?     @map("v2_bucket_probs")
  v3MfePrediction Float?    @map("v3_mfe_prediction")
  alertSent       Boolean   @default(false) @map("alert_sent")
  alertSentAt     DateTime? @map("alert_sent_at") @db.Timestamptz(6)
  featureVector   Json?     @map("feature_vector")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  status                String    @default("open") @db.VarChar(15)
  outcome               String?   @db.VarChar(15)
  exitPrice             Float?    @map("exit_price")
  rMultiple             Float?    @map("r_multiple")
  barsToOutcome         Int?      @map("bars_to_outcome")
  maxFavorableExcursion Float?    @map("max_favorable_excursion")
  maxAdverseExcursion   Float?    @map("max_adverse_excursion")
  resolvedAt            DateTime? @map("resolved_at") @db.Timestamptz(6)
  barsElapsed           Int?      @map("bars_elapsed")
  lastCheckedAt         DateTime? @map("last_checked_at") @db.Timestamptz(6)
  modelVersion          String?   @map("model_version") @db.VarChar(30)

  orders                Order[]

  @@unique([pair, timeframe, patternType, patternEnd])
  @@index([createdAt(sort: Desc)])
  @@index([pair, timeframe])
  @@index([status])
  @@index([status, timeframe])
  @@map("signals")
}

model ModelVersion {
  id           Int       @id @default(autoincrement())
  version      String    @unique @db.VarChar(30)
  trainedAt    DateTime  @map("trained_at") @db.Timestamptz(6)
  trainingSize Int       @map("training_size")
  v1Auc        Float?    @map("v1_auc")
  v2Accuracy   Float?    @map("v2_accuracy")
  v3R2         Float?    @map("v3_r2")
  v3Mae        Float?    @map("v3_mae")
  notes        String?
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("model_versions")
}

model AccuracySnapshot {
  id               Int       @id @default(autoincrement())
  modelVersion     String    @map("model_version") @db.VarChar(30)
  windowSize       Int       @map("window_size")
  v1Accuracy       Float?    @map("v1_accuracy")
  v2BucketAccuracy Float?    @map("v2_bucket_accuracy")
  v3MaeLive        Float?    @map("v3_mae_live")
  pair             String?   @db.VarChar(20)
  timeframe        String?   @db.VarChar(10)
  patternType      String?   @map("pattern_type") @db.VarChar(30)
  snapshotAt       DateTime  @map("snapshot_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([modelVersion, snapshotAt(sort: Desc)])
  @@map("accuracy_snapshots")
}

model Order {
  id            Int       @id @default(autoincrement())
  signalId      Int       @map("signal_id")
  brokerOrderId String?   @map("broker_order_id") @db.VarChar(100)
  pair          String    @db.VarChar(20)
  direction     String    @db.VarChar(10)
  volume        Float
  entryPrice    Float     @map("entry_price")
  slPrice       Float     @map("sl_price")
  tpPrice       Float     @map("tp_price")
  status        String    @default("pending") @db.VarChar(20)
  filledPrice   Float?    @map("filled_price")
  filledAt      DateTime? @map("filled_at") @db.Timestamptz(6)
  closedPrice   Float?    @map("closed_price")
  closedAt      DateTime? @map("closed_at") @db.Timestamptz(6)
  closedReason  String?   @map("closed_reason") @db.VarChar(30)
  pnl           Float?
  commission    Float?
  swap          Float?
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  signal        Signal    @relation(fields: [signalId], references: [id])

  @@index([signalId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("orders")
}

model RiskEvent {
  id        Int      @id @default(autoincrement())
  eventType String   @map("event_type") @db.VarChar(40)
  details   Json
  action    String   @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([eventType])
  @@index([createdAt(sort: Desc)])
  @@map("risk_events")
}

model DailyPnl {
  id            Int      @id @default(autoincrement())
  date          DateTime @unique @db.Date
  realizedPnl   Float    @default(0) @map("realized_pnl")
  unrealizedPnl Float    @default(0) @map("unrealized_pnl")
  tradesOpened  Int      @default(0) @map("trades_opened")
  tradesClosed  Int      @default(0) @map("trades_closed")
  highWaterMark Float    @default(0) @map("high_water_mark")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("daily_pnl")
}

model TradingState {
  id                Int       @id @default(1)
  enabled           Boolean   @default(false)
  killSwitchActive  Boolean   @default(false) @map("kill_switch_active")
  killSwitchReason  String?   @map("kill_switch_reason")
  lastKillSwitchAt  DateTime? @map("last_kill_switch_at") @db.Timestamptz(6)
  consecutiveLosses Int       @default(0) @map("consecutive_losses")
  highWaterMark     Float     @default(0) @map("high_water_mark")
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("trading_state")
}
